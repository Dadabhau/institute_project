<div class="container-fluid p-0">
  <h1 class="h3 mb-3"><strong>Institutes Branches</strong> Management</h1>
  <div class="row align-items-start">
    <div class="col-12 d-flex">
      <div class="card flex-fill">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">All Institutes Branches</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" (click)="openAddModal()">
              <fa-icon [icon]="faPlus"></fa-icon> Add New
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid p-0">
  <div class="row">
    <div class="col-xl-12 col-xxl-12 d-flex">
      <div class="w-100">
        <div class="row">
          <div class="col-sm-3" *ngFor="let branch of branches">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col mt-0">
                    <h5 class="card-title">
                      {{ isEditing ? 'Edit Institute' : branch.branchName }}
                    </h5>
                  </div>
                </div>
                <div *ngIf="!isEditing" class="row">
                  <div class="col-md-12">
                    <p>
                      <strong>Institute Name:</strong> {{ getInstituteName(branch.instituteId) }}
                    </p>
                    <p><strong>City:</strong> {{ branch.city }}</p>
                    <p><strong>State:</strong> {{ branch.state }}</p>
                    <p><strong>Pincode:</strong> {{ branch.pincode }}</p>
                    <p><strong>Location:</strong> {{ branch.location }}</p>
                  </div>

                  <div class="col-md-12">
                    <p><strong>Branch Contact No:</strong> {{ branch.branchContactNo }}</p>
                    <p><strong>Branch Email:</strong> {{ branch.branchEmail }}</p>
                    <p><strong>Branch Code:</strong> {{ branch.branchCode }}</p>
                  </div>
                </div>
                <div class="mb-0">
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="onEdit(branch)">
                    {{ !isEditing ? 'Edit' : 'Save' }}
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary me-2"
                    *ngIf="isEditing"
                    (click)="onCancel()"
                  >
                    Cancel
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="onDelete(branch.branchId)">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div
  class="modal"
  tabindex="-1"
  *ngIf="showAddModal"
  style="display: block; background: rgba(0, 0, 0, 0.7)"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form [formGroup]="branchForm" (ngSubmit)="onSubmit()">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ !isEditing ? 'Add Institutes Branch' : 'Update Institutes Branch' }}
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeAddModal()"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="mb-3 col-md-6">
              <label class="form-label">Branch Name</label>
              <input
                type="text"
                class="form-control"
                formControlName="branchName"
                [ngClass]="{ 'is-invalid': f['branchName'].touched && f['branchName'].invalid }"
              />
              @if(f['branchName'].touched && f['branchName'].invalid){
              <div class="invalid-feedback form-text">Branch name is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">City</label>
              <input
                type="text"
                class="form-control"
                formControlName="city"
                [ngClass]="{ 'is-invalid': f['city'].touched && f['city'].invalid }"
              />
              @if (f['city'].touched && f['city'].invalid) {
              <div class="invalid-feedback form-text">city is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">State</label>
              <input
                type="text"
                class="form-control"
                formControlName="state"
                [ngClass]="{ 'is-invalid': f['state'].touched && f['state'].invalid }"
              />
              @if(f['state'].touched && f['state'].invalid){
              <div class="invalid-feedback form-text">State is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Pincode</label>
              <input
                type="text"
                class="form-control"
                formControlName="pincode"
                [ngClass]="{ 'is-invalid': f['pincode'].touched && f['pincode'].invalid }"
              />
              @if(f['pincode'].touched && f['pincode'].invalid){
              <div class="invalid-feedback form-text">Pincode is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Location</label>
              <input
                type="text"
                class="form-control"
                formControlName="location"
                [ngClass]="{ 'is-invalid': f['location'].touched && f['location'].invalid }"
              />
              @if(f['location'].touched && f['location'].invalid){
              <div class="invalid-feedback form-text">Location is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Institute Name</label>
              <select
                formControlName="instituteId"
                class="form-select"
                [ngClass]="{
                  'is-invalid': (f['instituteId'].touched || submitted) && f['instituteId'].invalid
                }"
              >
                <option value="">Select Institute</option>
                <option *ngFor="let inst of institutes" [value]="inst.instituteId">
                  {{ inst.name }}
                </option>
              </select>
              @if(f['instituteId'].touched && f['instituteId'].invalid){
              <div class="invalid-feedback form-text">Institute Id is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Branch Contact No</label>
              <input
                type="text"
                class="form-control"
                formControlName="branchContactNo"
                [ngClass]="{
                  'is-invalid': f['branchContactNo'].touched && f['branchContactNo'].invalid
                }"
              />
              @if(f['branchContactNo'].touched && f['branchContactNo'].invalid){
              <div class="invalid-feedback form-text">Branch contact no is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Branch Email</label>
              <input
                type="text"
                class="form-control"
                formControlName="branchEmail"
                [ngClass]="{ 'is-invalid': f['branchEmail'].touched && f['branchEmail'].invalid }"
              />
              @if(f['branchEmail'].touched && f['branchEmail'].invalid){
              <div class="invalid-feedback form-text">Branch Email is required</div>
              }
            </div>
            <div class="mb-3 col-md-6">
              <label class="form-label">Branch Code</label>
              <input
                type="text"
                class="form-control"
                formControlName="branchCode"
                [ngClass]="{ 'is-invalid': f['branchCode'].touched && f['branchCode'].invalid }"
              />
              @if(f['branchCode'].touched && f['branchCode'].invalid){
              <div class="invalid-feedback form-text">Branch Code is required</div>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeAddModal()"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="branchForm.invalid">
            {{ isEditing ? 'Update' : 'Save' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
